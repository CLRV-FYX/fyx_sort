name: Professional CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å‘¨æ—¥æ—©ä¸Š2ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 2 * * 0'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘çš„åŸå› '
        required: false
        default: 'Manual trigger'

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€åˆ†æ”¯çš„å¤šä¸ªè¿è¡Œä¼šè¢«å–æ¶ˆï¼Œåªä¿ç•™æœ€æ–°çš„
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ç¯å¢ƒå˜é‡å¯ä»¥åœ¨æ‰€æœ‰ä½œä¸šä¸­ä½¿ç”¨
env:
  BUILD_TYPE: Release
  CC: gcc
  CXX: g++

jobs:
  # ä»£ç è´¨é‡å’Œå®‰å…¨æ£€æŸ¥
  lint-and-security:
    name: Lint & Security
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Check file headers
      run: |
        echo "ğŸ“„ æ£€æŸ¥æ–‡ä»¶å¤´..."
        if ! grep -q "Apache License" fyx_sort.hpp; then
          echo "âŒ æ–‡ä»¶å¤´ç¼ºå°‘è®¸å¯è¯å£°æ˜"
          exit 1
        fi
        echo "âœ… æ–‡ä»¶å¤´æ£€æŸ¥é€šè¿‡"
    
    - name: Run clang-tidy
      if: always()
      run: |
        echo "ğŸ” è¿è¡Œ clang-tidy..."
        sudo apt-get update
        sudo apt-get install -y clang-tidy-15
        # åªæ£€æŸ¥ä¸»è¦æ–‡ä»¶
        clang-tidy-15 fyx_sort.hpp -- \
          -std=c++17 -I. -DFYX_MAIN \
          -Wall -Wextra -Werror 2>&1 | tee clang-tidy-report.txt || true
    
    - name: Upload clang-tidy report
      uses: actions/upload-artifact@v4
      with:
        name: clang-tidy-report
        path: clang-tidy-report.txt
        retention-days: 7

  # ç¼–è¯‘æµ‹è¯• - è·¨å¹³å°å¤šé…ç½®
  build-and-test:
    name: Build & Test (${{ matrix.os }} - ${{ matrix.compiler }})
    runs-on: ${{ matrix.os }}
    needs: lint-and-security
    strategy:
      fail-fast: false  # ä¸€ä¸ªå¤±è´¥ä¸ä¼šåœæ­¢å…¶ä»–é…ç½®
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        compiler: [gcc, clang, msvc]
        exclude:
          - os: windows-latest
            compiler: gcc
          - os: windows-latest
            compiler: clang
          - os: macos-latest
            compiler: msvc
        include:
          # æ·»åŠ æ›´å¤šC++æ ‡å‡†ç‰ˆæœ¬
          - os: ubuntu-latest
            compiler: gcc
            cpp_std: 17
          - os: ubuntu-latest
            compiler: gcc
            cpp_std: 20
          - os: ubuntu-latest
            compiler: clang
            cpp_std: 17
          - os: windows-latest
            compiler: msvc
            cpp_std: 17
          - os: macos-latest
            compiler: clang
            cpp_std: 17
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup compiler
      run: |
        echo "ğŸ”§ è®¾ç½®ç¼–è¯‘å™¨: ${{ matrix.compiler }}"
        
        if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          sudo apt-get update
          if [[ "${{ matrix.compiler }}" == "gcc" ]]; then
            sudo apt-get install -y g++-12
            sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
            sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100
          elif [[ "${{ matrix.compiler }}" == "clang" ]]; then
            sudo apt-get install -y clang-15
            sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 100
            sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 100
          fi
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "CXX_STD=c++${{ matrix.cpp_std }}" >> $GITHUB_ENV
        
        if [[ "${{ matrix.compiler }}" == "msvc" ]]; then
          echo "COMPILER_CMD=cl" >> $GITHUB_ENV
          echo "COMPILER_FLAGS=/std:c++${{ matrix.cpp_std }} /EHsc /O2" >> $GITHUB_ENV
          echo "BINARY_EXT=.exe" >> $GITHUB_ENV
        else
          if [[ "${{ matrix.compiler }}" == "gcc" ]]; then
            echo "COMPILER_CMD=g++" >> $GITHUB_ENV
          else
            echo "COMPILER_CMD=clang++" >> $GITHUB_ENV
          fi
          echo "COMPILER_FLAGS=-std=c++${{ matrix.cpp_std }} -O2 -Wall -Wextra" >> $GITHUB_ENV
          echo "BINARY_EXT=" >> $GITHUB_ENV
        fi
    
    - name: Compile test program
      run: |
        echo "ğŸ“¦ ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
        
        if [[ "${{ matrix.compiler }}" == "msvc" ]]; then
          # Windows MSVC
          "${{ env.COMPILER_CMD }}" ${{ env.COMPILER_FLAGS }} /DFYX_MAIN /I. \
            fyx_sort.hpp /Fe:test_fyx${{ env.BINARY_EXT }}
        else
          # Linux/macOS GCC/Clang
          "${{ env.COMPILER_CMD }}" ${{ env.COMPILER_FLAGS }} -DFYX_MAIN \
            -o test_fyx${{ env.BINARY_EXT }} fyx_sort.hpp
        fi
        
        echo "âœ… ç¼–è¯‘å®Œæˆ"
    
    - name: Run tests
      run: |
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
        
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          ./test_fyx.exe
        else
          timeout 30s ./test_fyx
        fi
        
        echo "âœ… æµ‹è¯•é€šè¿‡"
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-binary-${{ matrix.os }}-${{ matrix.compiler }}-cpp${{ matrix.cpp_std }}
        path: |
          test_fyx*
        retention-days: 3

  # ä»£ç è¦†ç›–ç‡åˆ†æ
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup coverage tools
      run: |
        echo "ğŸ“Š è®¾ç½®è¦†ç›–ç‡å·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y gcovr lcov g++-12
        
    - name: Compile with coverage
      run: |
        g++-12 -std=c++20 -O0 -g --coverage -fprofile-arcs -ftest-coverage \
          -DFYX_MAIN -o test_coverage fyx_sort.hpp
        
    - name: Run tests with coverage
      run: |
        echo "ğŸ” è¿è¡Œè¦†ç›–ç‡æµ‹è¯•..."
        ./test_coverage
        echo "âœ… è¦†ç›–ç‡æµ‹è¯•å®Œæˆ"
        
    - name: Generate coverage report
      run: |
        echo "ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        
        # ç”Ÿæˆ LCOV æŠ¥å‘Š
        lcov --capture --directory . --output-file coverage.info
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --list coverage.info
        
        # ç”Ÿæˆ HTML æŠ¥å‘Š
        genhtml coverage.info --output-directory coverage
        
        # ä½¿ç”¨ gcovr ç”Ÿæˆ XML æŠ¥å‘Š
        gcovr --exclude-throw-branches --exclude-unreachable-branches \
          --print-summary --xml-pretty --xml coverage.xml \
          --html-details coverage-gcovr.html
        
        echo "ğŸ“Š è¦†ç›–ç‡ç»Ÿè®¡:"
        gcovr --branches --print-summary
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage/
          coverage-gcovr.html
          coverage.xml
          coverage.info
        retention-days: 30
    
    - name: Upload to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: build-and-test
    
    # åªåœ¨ç‰¹å®šæ¡ä»¶ä¸‹è¿è¡Œï¼Œé¿å…æ¯æ¬¡æäº¤éƒ½è¿è¡Œ
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup benchmark environment
      run: |
        echo "âš¡ è®¾ç½®åŸºå‡†æµ‹è¯•ç¯å¢ƒ..."
        sudo apt-get update
        sudo apt-get install -y python3 python3-pip python3-venv
        
        # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
        python3 -m venv venv
        source venv/bin/activate
        pip install matplotlib pandas numpy
    
    - name: Run benchmark script
      id: benchmark
      run: |
        source venv/bin/activate
        
        echo "ğŸƒ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
        
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„åŸºå‡†æµ‹è¯•è„šæœ¬
        cat > benchmark.py << 'PYTHON_EOF'
#!/usr/bin/env python3
"""
FYX-SORT æ€§èƒ½åŸºå‡†æµ‹è¯•
"""
import subprocess
import json
import time
import statistics
import sys
from pathlib import Path

def run_benchmark(name, compile_cmd, run_cmd, iterations=3):
    """è¿è¡Œå•ä¸ªåŸºå‡†æµ‹è¯•"""
    print(f"\\nğŸ”§ æµ‹è¯•: {name}")
    
    # ç¼–è¯‘
    print(f"  ç¼–è¯‘å‘½ä»¤: {compile_cmd}")
    compile_result = subprocess.run(compile_cmd, shell=True, capture_output=True)
    if compile_result.returncode != 0:
        print(f"  âŒ ç¼–è¯‘å¤±è´¥: {compile_result.stderr.decode()}")
        return None
    
    # è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼
    times = []
    for i in range(iterations):
        start = time.perf_counter()
        run_result = subprocess.run(run_cmd, shell=True, capture_output=True)
        end = time.perf_counter()
        
        if run_result.returncode == 0:
            elapsed = (end - start) * 1000  # è½¬æ¢ä¸ºæ¯«ç§’
            times.append(elapsed)
            print(f"  è¿è¡Œ {i+1}: {elapsed:.2f}ms")
        else:
            print(f"  è¿è¡Œ {i+1}: å¤±è´¥ - {run_result.stderr.decode()}")
    
    if times:
        avg = statistics.mean(times)
        std = statistics.stdev(times) if len(times) > 1 else 0
        print(f"  å¹³å‡: {avg:.2f}ms Â± {std:.2f}ms")
        return {"avg": avg, "std": std, "times": times}
    return None

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸš€ å¼€å§‹ FYX-SORT æ€§èƒ½åŸºå‡†æµ‹è¯•")
    
    results = {}
    base_dir = Path(".")
    
    # 1. ç¼–è¯‘æµ‹è¯•ç¨‹åº
    test_programs = {
        "int_sort": "test_int.cpp",
        "string_sort": "test_string.cpp",
        "large_obj_sort": "test_large.cpp"
    }
    
    # åˆ›å»ºæµ‹è¯•ç¨‹åº
    for test_name, filename in test_programs.items():
        if test_name == "int_sort":
            code = '''
#include "fyx_sort.hpp"
#include <vector>
#include <random>
#include <chrono>
#include <iostream>

int main() {
    const size_t N = 1000000;
    std::vector<int> data(N);
    std::mt19937 rng(42);
    for (auto& x : data) x = rng();
    
    auto start = std::chrono::high_resolution_clock::now();
    fyx::sort(data);
    auto end = std::chrono::high_resolution_clock::now();
    
    auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(end - start);
    std::cout << ms.count();
    return 0;
}
'''
        elif test_name == "string_sort":
            code = '''
#include "fyx_sort.hpp"
#include <vector>
#include <string>
#include <random>
#include <chrono>
#include <iostream>

int main() {
    const size_t N = 100000;
    std::vector<std::string> data(N);
    std::mt19937 rng(42);
    
    for (auto& s : data) {
        s.resize(10 + rng() % 20);
        for (char& c : s) c = 'a' + (rng() % 26);
    }
    
    auto start = std::chrono::high_resolution_clock::now();
    fyx::sort(data);
    auto end = std::chrono::high_resolution_clock::now();
    
    auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(end - start);
    std::cout << ms.count();
    return 0;
}
'''
        else:  # large_obj_sort
            code = '''
#include "fyx_sort.hpp"
#include <vector>
#include <random>
#include <chrono>
#include <iostream>

struct LargeObject {
    int key;
    char data[256];
    bool operator<(const LargeObject& other) const { return key < other.key; }
};

int main() {
    const size_t N = 50000;
    std::vector<LargeObject> data(N);
    std::mt19937 rng(42);
    
    for (auto& obj : data) {
        obj.key = rng();
    }
    
    auto start = std::chrono::high_resolution_clock::now();
    fyx::sort(data);
    auto end = std::chrono::high_resolution_clock::now();
    
    auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(end - start);
    std::cout << ms.count();
    return 0;
}
'''
        
        with open(base_dir / filename, "w") as f:
            f.write(code)
        print(f"âœ… åˆ›å»ºæµ‹è¯•ç¨‹åº: {filename}")
    
    # 2. è¿è¡ŒåŸºå‡†æµ‹è¯•
    for test_name, filename in test_programs.items():
        compile_cmd = f"g++ -std=c++17 -O3 -march=native -I. {filename} -o {test_name}"
        run_cmd = f"./{test_name}"
        
        result = run_benchmark(test_name, compile_cmd, run_cmd, 3)
        if result:
            results[test_name] = result
    
    # 3. ä¿å­˜ç»“æœ
    with open("benchmark_results.json", "w") as f:
        json.dump({
            "timestamp": time.time(),
            "commit": sys.argv[1] if len(sys.argv) > 1 else "unknown",
            "results": results
        }, f, indent=2)
    
    print(f"\\nğŸ“Š åŸºå‡†æµ‹è¯•å®Œæˆ! ç»“æœä¿å­˜åˆ° benchmark_results.json")
    
    # è¾“å‡ºæ‘˜è¦
    print("\\nğŸ“ˆ æ€§èƒ½æ‘˜è¦:")
    for test_name, result in results.items():
        print(f"  {test_name}: {result['avg']:.2f}ms Â± {result['std']:.2f}ms")
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
PYTHON_EOF
        
        # è¿è¡ŒåŸºå‡†æµ‹è¯•
        python3 benchmark.py "${{ github.sha }}"
    
    - name: Generate benchmark report
      run: |
        echo "ğŸ“Š ç”ŸæˆåŸºå‡†æµ‹è¯•æŠ¥å‘Š..."
        source venv/bin/activate
        
        # ç®€å•çš„æŠ¥å‘Šç”Ÿæˆ
        if [ -f "benchmark_results.json" ]; then
          python3 -c "
import json
import sys

with open('benchmark_results.json') as f:
    data = json.load(f)

print('# ğŸš€ FYX-SORT æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š')
print(f'**æäº¤:** {data[\"commit\"][:8]}')
print(f'**æ—¶é—´:** {data[\"timestamp\"]}')
print('')
print('## æµ‹è¯•ç»“æœ')
print('| æµ‹è¯•ç±»å‹ | å¹³å‡æ—¶é—´ (ms) | æ ‡å‡†å·® (ms) |')
print('|----------|--------------|------------|')

for test_name, result in data['results'].items():
    avg = result['avg']
    std = result['std']
    print(f'| {test_name} | {avg:.2f} | {std:.2f} |')

print('')
print('## è¯´æ˜')
print('- **int_sort**: æ’åº 1,000,000 ä¸ªéšæœºæ•´æ•°')
print('- **string_sort**: æ’åº 100,000 ä¸ªéšæœºå­—ç¬¦ä¸² (10-30å­—ç¬¦)')
print('- **large_obj_sort**: æ’åº 50,000 ä¸ªå¤§å¯¹è±¡ (260å­—èŠ‚)')
          " | tee benchmark_summary.md
        else
          echo "âŒ åŸºå‡†æµ‹è¯•ç»“æœæ–‡ä»¶ä¸å­˜åœ¨"
        fi
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          benchmark_results.json
          benchmark_summary.md
          *.cpp  # æµ‹è¯•ç¨‹åºæºæ–‡ä»¶
        retention-days: 30

  # å‘å¸ƒå·¥ä½œæµï¼ˆåªåœ¨æ‰“æ ‡ç­¾æ—¶è¿è¡Œï¼‰
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [coverage, benchmark]
    # åªåœ¨æ¨é€æ ‡ç­¾æ—¶è¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºå‘å¸ƒ
      packages: write
      attestations: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract version
      id: get_version
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
    
    - name: Create release package
      run: |
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ… v${{ env.VERSION }}..."
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p fyx-sort-${{ env.VERSION }}
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶
        cp README.md LICENSE fyx_sort.hpp fyx-sort-${{ env.VERSION }}/
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czf fyx-sort-${{ env.VERSION }}.tar.gz fyx-sort-${{ env.VERSION }}
        zip -r fyx-sort-${{ env.VERSION }}.zip fyx-sort-${{ env.VERSION }}
        
        # åˆ›å»ºå•æ–‡ä»¶ç‰ˆæœ¬ï¼ˆä¾¿äºç›´æ¥åŒ…å«ï¼‰
        cp fyx_sort.hpp fyx-sort-v${{ env.VERSION }}.hpp
        
        echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          fyx-sort-${{ env.VERSION }}.tar.gz
          fyx-sort-${{ env.VERSION }}.zip
          fyx-sort-v${{ env.VERSION }}.hpp
        generate_release_notes: true
        prerelease: ${{ contains(env.VERSION, '-') }}
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ€»ç»“æŠ¥å‘Šï¼ˆæ€»æ˜¯è¿è¡Œï¼‰
  summary:
    name: Summary Report
    runs-on: ubuntu-latest
    needs: [lint-and-security, build-and-test, coverage, benchmark]
    if: always()
    
    steps:
    - name: Generate workflow summary
      run: |
        echo "# ğŸ“‹ CI/CD å·¥ä½œæµæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **å·¥ä½œæµ:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘äº‹ä»¶:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ä½œä¸šçŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "| ä½œä¸š | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        
        # è¿™é‡Œæ— æ³•åŠ¨æ€è·å–ä½œä¸šçŠ¶æ€ï¼Œæ‰€ä»¥ç•™ç©º
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
        echo "- æŸ¥çœ‹è¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šå’Œè¦†ç›–ç‡" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸‹è½½ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å’ŒæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- å¦‚æœ‰å¤±è´¥ï¼Œè¯·æŸ¥çœ‹å¯¹åº”ä½œä¸šçš„æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        
        echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
