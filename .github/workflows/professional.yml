name: Professional CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥æ—©ä¸Š2ç‚¹è¿è¡Œ

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y g++-12 gcovr lcov
        
    - name: Compile with coverage
      run: |
        g++-12 -std=c++20 -O0 -g --coverage -fprofile-arcs -ftest-coverage \
          -DFYX_MAIN -o test_coverage fyx_sort.hpp
    
    - name: Run tests with coverage
      run: |
        ./test_coverage
        
    - name: Generate coverage report
      run: |
        gcovr --exclude-throw-branches --exclude-unreachable-branches \
          --print-summary --xml-pretty --xml coverage.xml \
          --html-details coverage.html
          
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          coverage.html
          coverage.xml

  clang-tidy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install clang-tidy
      run: sudo apt-get install -y clang-tidy-14
        
    - name: Run clang-tidy
      run: |
        clang-tidy-14 fyx_sort.hpp -- \
          -std=c++17 -I. -DFYX_MAIN 2>&1 | tee clang-tidy-report.txt
        
    - name: Upload clang-tidy report
      uses: actions/upload-artifact@v3
      with:
        name: clang-tidy-report
        path: clang-tidy-report.txt

  cross-platform:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, windows-2022, macos-12]
        include:
          - os: ubuntu-20.04
            compiler: g++-9
          - os: ubuntu-22.04
            compiler: g++-11
          - os: windows-2022
            compiler: cl
          - os: macos-12
            compiler: clang++
            
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Windows
      if: matrix.os == 'windows-2022'
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Install compiler (Linux)
      if: startsWith(matrix.os, 'ubuntu')
      run: |
        sudo apt-get update
        sudo apt-get install -y ${{ matrix.compiler }}
        
    - name: Compile
      shell: bash
      run: |
        echo "Testing on ${{ matrix.os }} with ${{ matrix.compiler }}"
        
        if [ "${{ matrix.os }}" == "windows-2022" ]; then
          cl /std:c++17 /O2 /DFYX_MAIN /I. fyx_sort.hpp /Fe:test_fyx.exe
          ./test_fyx.exe
        else
          ${{ matrix.compiler }} -std=c++17 -O2 -DFYX_MAIN -o test_fyx fyx_sort.hpp
          ./test_fyx
        fi

  performance-benchmark:
    runs-on: ubuntu-latest
    needs: [unit-tests, cross-platform]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install benchmark tools
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        pip3 install matplotlib pandas
        
    - name: Run performance comparison
      run: |
        cat > benchmark.py << 'EOF'
        import subprocess
        import time
        import json
        import statistics
        
        def benchmark(name, compile_cmd, run_cmd, iterations=3):
            print(f"\nğŸ”§ Benchmarking: {name}")
            
            # ç¼–è¯‘
            compile_result = subprocess.run(compile_cmd, shell=True, capture_output=True)
            if compile_result.returncode != 0:
                print(f"âŒ Compilation failed: {compile_result.stderr.decode()}")
                return None
            
            # è¿è¡Œå¤šæ¬¡å–å¹³å‡å€¼
            times = []
            for i in range(iterations):
                start = time.perf_counter()
                run_result = subprocess.run(run_cmd, shell=True, capture_output=True)
                end = time.perf_counter()
                
                if run_result.returncode == 0:
                    elapsed = end - start
                    times.append(elapsed)
                    print(f"  Run {i+1}: {elapsed:.2f}s")
                else:
                    print(f"  Run {i+1}: Failed")
            
            if times:
                avg = statistics.mean(times)
                std = statistics.stdev(times) if len(times) > 1 else 0
                print(f"  Average: {avg:.2f}s Â± {std:.2f}s")
                return avg
            return None
        
        # æ¯”è¾ƒ FYX-SORT å’Œ std::sort
        results = {}
        
        # ç¼–è¯‘æµ‹è¯•ç¨‹åº
        with open("test_perf.cpp", "w") as f:
            f.write("""
            #include "fyx_sort.hpp"
            #include <vector>
            #include <random>
            #include <chrono>
            #include <iostream>
            #include <algorithm>
            
            int main() {
                const size_t N = 1000000;
                std::vector<int> data(N);
                std::mt19937 rng(42);
                std::generate(data.begin(), data.end(), rng);
                
                // Test FYX-SORT
                auto fyx_data = data;
                auto start = std::chrono::high_resolution_clock::now();
                fyx::sort(fyx_data);
                auto end = std::chrono::high_resolution_clock::now();
                auto fyx_time = std::chrono::duration<double>(end - start).count();
                
                // Test std::sort
                auto std_data = data;
                start = std::chrono::high_resolution_clock::now();
                std::sort(std_data.begin(), std_data.end());
                end = std::chrono::high_resolution_clock::now();
                auto std_time = std::chrono::duration<double>(end - start).count();
                
                std::cout << fyx_time << " " << std_time;
                return 0;
            }
            """)
        
        # è¿è¡ŒåŸºå‡†æµ‹è¯•
        compile_cmd = "g++ -std=c++17 -O3 -march=native -I. test_perf.cpp -o test_perf"
        run_cmd = "./test_perf"
        
        result = subprocess.run(f"{compile_cmd} && {run_cmd}", shell=True, capture_output=True, text=True)
        
        if result.returncode == 0:
            fyx_time, std_time = map(float, result.stdout.strip().split())
            speedup = std_time / fyx_time if fyx_time > 0 else 0
            results = {
                "fyx_time": fyx_time,
                "std_time": std_time,
                "speedup": speedup,
                "status": "success"
            }
            print(f"\nâœ… Performance results:")
            print(f"   FYX-SORT: {fyx_time:.3f}s")
            print(f"   std::sort: {std_time:.3f}s")
            print(f"   Speedup: {speedup:.2f}x")
        else:
            results = {"status": "failed", "error": result.stderr}
            print(f"\nâŒ Performance test failed: {result.stderr}")
        
        # ä¿å­˜ç»“æœ
        with open("benchmark_results.json", "w") as f:
            json.dump(results, f, indent=2)
        EOF
        
        python3 benchmark.py
        
    - name: Upload benchmark data
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: |
          benchmark_results.json

  deploy-docs:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [unit-tests, performance-benchmark]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Generate documentation
      run: |
        # åˆ›å»ºç®€å•çš„ HTML æ–‡æ¡£
        mkdir -p docs
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>FYX-SORT Documentation</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
            </style>
        </head>
        <body>
            <h1>FYX-SORT v2.0</h1>
            <p>Last updated: $(date)</p>
            <p>Commit: ${{ github.sha }}</p>
            <h2>Quick Start</h2>
            <pre><code>#include "fyx_sort.hpp"
// That's it!</code></pre>
        </body>
        </html>
        EOF
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
